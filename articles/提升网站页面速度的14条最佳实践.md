> 出处：[高性能网站建设指南](https://book.douban.com/subject/2084131/)
> 时间：2016.05.05

# 前言
之前一直在关注前端性能这块，但是很少有时间整理一下，最近也刚好在看高性能网站建设指南这本书，结合文中的内容做一个笔记，若有错误或表述不准确的地方，还望大家多多指正。

# 提升网站页面速度的14条最佳实践

## 第1条 减少HTTP请求
  **1. CSS Sprites**  
  CSS Sprites（也称CSS雪碧图），现在用的很多。基本的原理是把很多小的图片/图标放在一个大的图片里面，当需要使用某个图片/图标时，定义background-image，设置对应的图片坐标就行。  
  工具：[http://spritegen.website-performance.org/](http://spritegen.website-performance.org/)  
  优点：有效地较少了HTTP的请求，同时下载量变小（颜色表、格式信息减少了）等。  
  缺点：暂无。

  **2. 合并脚本和样式表**  
  过多的脚本和样式表会添加大量的HTTP请求，浏览器并行下载资源大概只有4-20之间（不同版本的浏览器表现不一样）。所以将脚本和样式表合并无疑会减少HTTP开销。但是一般在模块化开发下，是建议将不同功能的脚本和样式分开，所以我们通常需要借用前端自动化构建工具来实现。原理是在开发完成后，将各个不同的脚本或者样式文件进行合并。  

  **工具**：[grunt](http://www.gruntjs.net/)、[gulp](http://www.gulpjs.com.cn/)、[webpack](http://webpack.github.io/)、[npm scripts](https://docs.npmjs.com/misc/scripts)  
  **优点**：减少HTTP请求。  
  **缺点**：当项目中存在大量的脚本和样式文件时，如何组合将变的困难。  

  **3. 图片地图**  
  图片地图是一种比较老的方式了，原理就是当多个图片一起排列时，将这些图片整合成一张图片，通过对这张图片的点击位置信息做区分，采取不同的响应方式。其实这种方式可以用CSS Sprite来取代了。  

## 第2条 减少DNS查找
  Internet是通过IP地址来查找服务器的。由于IP地址很难记，所以就出现域名，DNS作用就是将域名映射带IP上。  

  **原理**：DNS的解析过程通常是当你输入一个域名时，首先去浏览器DNS缓存中查找；如果找不到，就会从操作系统中DNS缓存中查找；如果还是找不到，就会去外部的DNS域名服务器上查找。一个页面中，增加一个域名，可以增加几个并行下载，同时DNS的解析时间会边长。合理的解决办法是：当页面中组件很少时，域名越少越好；当页面中组件很多时，则增加域名（建议2-4个），这样效果更好。

## 第3条 避免重定向
  重定向用于将用户从一个URL重新路由到另一个URL。重定向主要分两类：客户端重定向，服务端重定向。客户端重定向有两种方式，一种是在HTML文档的头中包含meta refresh表圈，可以在其content属性所指定的秒数之后重定向；另外一种是在js设置document.location。服务端的重定向常用的是永久重定向（301）和临时重定向（302），区别如下：比如A重定向到B，301告诉搜索引擎，B是我关注的重点，请把搜索的权重给B；302告诉搜索引擎，A是我关注的重点，我只是临时指向B，请把权重保留给A。曾经302一直作为骗取SEO权重的一种手段，不过现在搜索引擎修复了这个bug。  

  **原理**：重定向的使用会使页面响应的时间变长，用户体验变差；正常情况下，应避免使用重定向，可以在服务器端做相应的配置。如果实在需要做重定向，应该在服务器端利用301来进行重定向。  
  **优点**：减少页面响应时间。  
  **缺点**：暂无。  

## 第4条 使用CDN（内容发布网络）  
  内容分发网络的基本思路就是将你的web应用部署在不同的地理位置的服务器中，当用户访问你的网站时，CDN会选择一个离你最近或者网络速度更快的服务器来响应你的请求。  

  **工具**：自己搭建或者采用第三方CDN提供商的服务。  
  **优点**：有效的节约资源下载的时间。  
  **缺点**：采用第三方CDN提供商的服务，很多性能都得取决于CDN提供商的服务的好坏。  

## 第5条 压缩组件Gzip
  现在在很多网站中用来Gzip压缩，要了解Gzip，首先理解下面几个问题。  
  1. Gzip是什么？  
  Gzip是一种在服务器端压缩html、脚本和样式文件的压缩技术（ps.通常我们不压缩图片、pdf等文件，因为这些文件一般已经压缩处理过了，再次压缩只会浪费cpu性能）。  
  2. 浏览器中怎么查看是否应用了Gzip？  
  在请求头里用`Accept-Encoding: gzip`表示；在响应头里用`Content-Encoding: gzip`表示。  
  3. 在nodejs、ngnix中怎么配置Gzip？  
  参考：[node.js 和 nginx 配合实现 gzip 压缩,让网站浏览更顺畅](http://yijiebuyi.com/blog/2ba090a3835d430726c922753b60b2ee.html)  


  **优点**：减少响应包大小。  
  **缺点**：在利用代理服务器（比如ngnix）时，注意配置代理缓存（打开gzip-vary字段）  


## 第6条 添加Expire/Cache-Control头
  Expire和Cache-Control都是服务器中配置的缓存策略的参数。它们两个实现的功能是相同的，都是为了在浏览器中缓存资源，区别在于Expire设置的是具体的某一时间点；Cache-Control设置的是具体的一段时间。  
  Expire是http1.0的标准，而Cache-Control是htpp1.1的标准。出现Cache-Control的原因是Expire有个缺点，就是它要求服务器和客户端的时钟严格同步。  
  不过在开发中，为了保持兼容性，我们常常同时设置这两个参数（ps.Cache-Control的优先级大于Expire）。  

  **原理**：浏览器第一次发送请求，服务端返回响应，响应头中包含了Expire/Cache-Control，告诉浏览器在什么时间段内可以直接利用缓存，而**不用向服务器发送请求**。  
  **优点**：减少http请求，提高页面响应速度。  
  **缺点**：通常配置Expire/Cache-Control后，如果在缓存时间内，客户端是不会向服务端发送请求的，这样可能会导致加载的资源不是最新的。解决办法是将版本号嵌入在文件名中。  


## 第7条 配置ETag/Last-Modify
  ETag/Last-Modify是确认缓存组件是否有效的一种机制。在上一条规则中我们知道了Expire/Cache-Control，ETag/Last-Modify的作用其实就是当Expire/Cache-Control过期了，客户端向服务端发送请求时校验缓存组件是否改变了，如果没有改变，服务端返回304，浏览器继续使用缓存；如果改变了，则服务端返回新的资源。我们也称之为“条件GET请求”。  

  **原理**：  
    Last-Modify：客户端第一次请求资源，服务端返回响应，响应头中设置Last-Modify字段；当客户端以后再次请求资源时，在请求头中设置If-Modified-Since字段（其值等于服务器第一次返回的Last-Modify字段）。服务器接收到这个请求后，首先判断文件的修改日期是否更改了，如果没有，返回304；如果更改了，返回新的资源。  
    ETag：ETag是根据请求资源的某些属性来构造的，比如时间、User-Agency等。客户端第一次请求资源，服务端返回响应，响应头中设置ETag字段；当客户端以后再次请求资源时，在请求头中设置If-None-Match字段（其值等于服务器第一次返回的ETag字段）。服务器接收到这个请求后，首先判断ETag是否更改了，如果没有，返回304；如果更改了，返回新的资源。  
    区别：ETag是http1.1的标准，优先级大于Last-Modify。  
  **优点**：有效节约了带宽。  
  **缺点**：主要是ETag的缺点。因为ETag是根据请求资源的某些属性来生成的，不如User-Agency。在一些集群的环境下会出现资源相同但ETag不同的问题，这样ETag就没起到节约带宽的作用。解决办法：不用ETag或者尽量用一些相同资源共同不变的属性（比如文件大小、时间等）。  

## 第8条 使Ajax可缓存
  Ajax缓存是指在用户第一次请求过Ajax后，在客户端缓存响应的内容，当用户再次请求相同的Ajax，可以直接利用第一次的缓存。具体的优化方案，可以参照规则2、3、5、6、7。

## 第9条 使用外部JavaScript和CSS
  我们在接触JavaScript和CSS的时候，前辈就告诉我们：要将JavaScript和CSS文件存放在外部，在html中用link和script标签来引用。事实上我们也应该这样做，不过，有时会你的页面比较独立，基本不需要重用JS、CSS，但是对页面加载性能非常关注，比如某一运营首页。采用内联JavaScript和CSS可能更好一点，毕竟减少了http请求。  

  **优点**：便于维护，利于JS、CSS代码的复用，可以依靠缓存减少加载时间。
  **缺点**：当页面需要加载资源很少、比较独立、且空缓存时，优化效果可能变差。

## 第10条 将样式表放在顶部
  很多人知道要将样式表放在head里，但是真正知道原因的却不是特别多。因为按照常理讲，html是按文档的从上到下的顺序加载的，将CSS文件放在前面，难道不会阻塞页面内容的加载吗？事实上确实会，但是相比将CSS放在底部，放在顶部的性能还是好多了。怎么理解？首先要了解浏览器渲染页面的过程。服务端返回一个html文件给浏览器，浏览器首先会生成一个dom树，然后再生成一个渲染树，最后将页面显示在浏览器中。其中生成渲染树的过程就要利用CSS文件，所以如果CSS文件一直没有加载完成，就会出现白屏或者无样式内容闪烁（FOUC）。

## 第11条 将脚本放在底部
  脚本放在底部为了是页面内容更早的显示出来，这里有一个点需要注意的，就是在加载脚本的时候，会阻塞其他所有资源的下载。浏览器之所以采取这个策略，是因为担心js中有document.write的语句填充dom结构。

## 第12条 避免CSS表达式

## 第13条 精简Javascript

## 第14条 删除重复脚本
